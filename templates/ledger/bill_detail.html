{% extends 'base.html' %}
{% load static %}

{% block title %}Invoice {{ bill.bill_number }} - TMS{% endblock %}

{% block content %}
<div class="mb-4 d-print-none">
    <a href="{% url 'bill-list' %}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back to List</a>
    <button onclick="window.print()" class="btn btn-primary ms-2"><i class="bi bi-printer"></i> Print Invoice</button>
    {% if bill.status == 'Draft' %}
        <span class="badge bg-warning text-dark ms-2">DRAFT</span>
    {% endif %}
    {% if perms.ledger.change_financialrecord %}
        <a href="{% url 'bill-update' bill.pk %}" class="btn btn-warning ms-2"><i class="bi bi-pencil"></i> Edit</a>
    {% endif %}
</div>

<div class="card shadow-sm print-area">
    <div class="card-body p-5">
        <!-- Header -->
        <div class="row mb-5">
            <div class="col-6">
                <h2 class="fw-bold text-primary">{{ company_profile.company_name|default:"TRANSPORT COMPANY" }}</h2>
                <div class="text-muted">
                    {{ company_profile.address|linebreaksbr }}
                </div>
            </div>
            <div class="col-6 text-end">
                <h1 class="display-6 fw-bold mb-3">INVOICE</h1>
                <table class="table table-borderless float-end" style="width: auto;">
                    <tr>
                        <th class="text-end py-1">Invoice #:</th>
                        <td class="text-end py-1 fw-bold">{{ bill.bill_number|default:"DRAFT" }}</td>
                    </tr>
                    <tr>
                        <th class="text-end py-1">Date:</th>
                        <td class="text-end py-1">{{ bill.date }}</td>
                    </tr>
                    <tr>
                        <th class="text-end py-1">GST Rate:</th>
                        <td class="text-end py-1">{{ bill.get_gst_rate_display }}</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Bill To -->
        <div class="row mb-5">
            <div class="col-6">
                <h5 class="fw-bold text-secondary text-uppercase border-bottom pb-2 mb-3" style="width: 50%;">Bill To</h5>
                <h4 class="fw-bold">{{ bill.party.name }}</h4>
                <div class="text-muted">
                    {{ bill.party.address|linebreaksbr }}<br>
                    {% if bill.party.phone_number %}Phone: {{ bill.party.phone_number }}{% endif %}
                </div>
            </div>
        </div>

        <!-- Trips Table -->
        <div class="table-responsive mb-5">
            <table class="table table-striped table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Trip #</th>
                        <th>Vehicle</th>
                        <th>From / To</th>
                        <th class="text-end">Weight (Ton)</th>
                        <th class="text-end">Rate</th>
                        <th class="text-end">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trip in bill.trips.all %}
                    <tr>
                        <td>{{ trip.date|date:"d M Y" }}</td>
                        <td>{{ trip.trip_number }}</td>
                        <td>{{ trip.vehicle.registration_plate }}</td>
                        <td>
                            {{ trip.pickup_location }} <i class="bi bi-arrow-right-short"></i> {{ trip.delivery_location }}
                        </td>
                        <td class="text-end">{{ trip.weight }}</td>
                        <td class="text-end">{{ trip.rate_per_ton }}</td>
                        <td class="text-end">{{ trip.revenue|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <td colspan="6" class="text-end fw-bold">Subtotal</td>
                        <td class="text-end fw-bold">{{ bill.subtotal|floatformat:2 }}</td>
                    </tr>
                    {% if bill.gst_rate > 0 %}
                    <tr>
                        <td colspan="6" class="text-end">GST ({{ bill.gst_rate }}%)</td>
                        <td class="text-end">{{ bill.gst_amount|floatformat:2 }}</td>
                    </tr>
                    {% endif %}
                    <tr class="bg-primary text-white">
                        <td colspan="6" class="text-end fw-bold fs-5">Total</td>
                        <td class="text-end fw-bold fs-5">{{ bill.total_amount|floatformat:2 }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Footer / Bank Details -->
        <div class="row mt-5">
            <div class="col-7">
                <h6 class="fw-bold border-bottom pb-2 mb-3">Bank Details</h6>
                <div class="text-muted small">
                    {{ company_profile.bank_details|linebreaksbr|default:"No bank details configured." }}
                </div>
            </div>
            <div class="col-5 text-end d-flex flex-column justify-content-end">
                <div class="mb-5"></div> <!-- Spacing for signature -->
                <div class="border-top pt-2 d-inline-block" style="min-width: 200px;">
                    <p class="mb-0 fw-bold">{{ company_profile.authorized_signatory|default:"Authorized Signatory" }}</p>
                    <small class="text-muted">{{ company_profile.company_name }}</small>
                </div>
            </div>
        </div>
        
        <!-- Terms -->
        <div class="mt-5 pt-3 border-top text-center text-muted small">
            <p>Thank you for your business.</p>
        </div>
    </div>
</div>

<style>
    @media print {
        body * {
            visibility: hidden;
        }
        .print-area, .print-area * {
            visibility: visible;
        }
        .print-area {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            border: none !important;
            box-shadow: none !important;
        }
        .d-print-none {
            display: none !important;
        }
    }
</style>
{% endblock %}
