{% extends 'base.html' %}

{% block title %}{% if object %}Edit{% else %}Add{% endif %} Financial Record - Transport Management System{% endblock %}

{% block content %}
<h2>{% if object %}Edit Financial Record{% else %}Add Financial Record{% endif %}</h2>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    
    {% for field in form %}
        <div class="mb-3">
            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
            {{ field }}
            {% if field.errors %}
                <div class="text-danger small mt-1">
                    {{ field.errors }}
                </div>
            {% endif %}
            {% if field.help_text %}
                <div class="form-text">{{ field.help_text }}</div>
            {% endif %}
        </div>
    {% endfor %}
    
    <div class="mt-4">
        <button type="submit" class="btn btn-success">
            {% if object %}Update Record{% else %}Add Record{% endif %}
        </button>
        <a href="{% if object %}{% url 'financialrecord-detail' object.pk %}{% else %}{% url 'financialrecord-list' %}{% endif %}" 
           class="btn btn-outline-secondary ms-2">Cancel</a>
    </div>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const partySelect = document.getElementById('id_party');
        const driverField = document.getElementById('id_driver');
        const legsContainer = document.getElementById('id_associated_legs');
        
        // Wrapper for driver field (if it exists)
        // Bootstrap 5 form groups usually don't have a specific class like .form-group unless we added it.
        // We used .mb-3 in the loop above.
        const driverFieldWrapper = driverField ? driverField.closest('.mb-3') : null;

        // Helper to fetch and render legs
        function fetchLegs(partyId) {
            if (!partyId || !legsContainer) {
                if (legsContainer) legsContainer.innerHTML = '';
                return;
            }

            // Show loading state
            legsContainer.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Loading trips...';

            fetch(`{% url 'get-party-unpaid-legs' %}?party_id=${partyId}`)
                .then(response => response.json())
                .then(data => {
                    legsContainer.innerHTML = ''; // Clear loading
                    
                    if (data.legs && data.legs.length > 0) {
                        data.legs.forEach(leg => {
                            const div = document.createElement('div');
                            div.className = 'form-check';
                            
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.name = 'associated_legs';
                            checkbox.value = leg.id;
                            checkbox.className = 'form-check-input';
                            checkbox.id = 'leg_' + leg.id;
                            
                            const label = document.createElement('label');
                            label.className = 'form-check-label';
                            label.htmlFor = 'leg_' + leg.id;
                            label.textContent = leg.label;
                            
                            div.appendChild(checkbox);
                            div.appendChild(label);
                            
                            legsContainer.appendChild(div);
                        });
                    } else {
                        legsContainer.innerHTML = '<p class="text-muted fst-italic mb-0">No unpaid legs found for this party.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching legs:', error);
                    if (legsContainer) legsContainer.innerHTML = '<p class="text-danger mb-0">Error loading trip legs.</p>';
                });
        }

        // Initial check for legs if party selected on load (Edit or Pre-filled)
        if (partySelect && partySelect.value && legsContainer) {
            const hasOptions = legsContainer.querySelectorAll('input[type="checkbox"]').length > 0;
            if (!hasOptions) {
                fetchLegs(partySelect.value);
            }
        }

        // Event listener for party change
        if (partySelect) {
            partySelect.addEventListener('change', function() {
                fetchLegs(this.value);
                if (driverFieldWrapper) {
                    if (this.value) driverFieldWrapper.style.display = 'none';
                    else driverFieldWrapper.style.display = 'block';
                }
            });
        }
    });
</script>
{% endblock %}