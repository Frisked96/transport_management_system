{% extends 'base.html' %}

{% block title %}{{ trip.trip_number }} - Transport Management System{% endblock %}

{% block content %}
<div class="clearfix mb-1">
    <h2 style="float: left;">Trip Details: {{ trip.trip_number }}</h2>
    <div style="float: right;">
        <a href="{% url 'trip-list' %}" class="btn">Back to List</a>
        
        {% if perms.trips.change_trip %}
            <a href="{% url 'trip-update' trip.pk %}" class="btn btn-warning">Edit Trip</a>
        {% endif %}
        
        {% if perms.trips.can_update_trip_status or user == trip.driver %}
            <a href="{% url 'trip-status-update' trip.pk %}" class="btn btn-success">Update Status</a>
        {% endif %}
        
        {% if perms.trips.delete_trip %}
            <a href="{% url 'trip-delete' trip.pk %}" class="btn btn-danger">Delete Trip</a>
        {% endif %}
    </div>
</div>

<!-- Trip Information -->
<table>
    <tr>
        <th>Trip Number</th>
        <td>{{ trip.trip_number }}</td>
    </tr>
    <tr>
        <th>Status</th>
        <td>
            <span class="status-badge status-{{ trip.status|slugify }}">
                {{ trip.status }}
            </span>
            {% if trip.is_overdue and trip.status != trip.STATUS_COMPLETED %}
                <span style="color: #e74c3c; font-weight: bold; margin-left: 10px;">OVERDUE</span>
            {% endif %}
        </td>
    </tr>
    <tr>
        <th>Assigned Driver</th>
        <td>{{ trip.driver.get_full_name|default:trip.driver.username }}</td>
    </tr>
    <tr>
        <th>Assigned Vehicle</th>
        <td>
            <a href="{% url 'vehicle-detail' trip.vehicle.pk %}">
                {{ trip.vehicle.registration_plate }} - {{ trip.vehicle.make_model }}
            </a>
        </td>
    </tr>
    <tr>
        <th>Trip Dates</th>
        <td>
            {% if trip.start_date %}
                {{ trip.start_date|date:"M d, Y H:i" }}
                {% if trip.end_date %}
                     - {{ trip.end_date|date:"M d, Y H:i" }}
                {% endif %}
            {% else %}
                <em>No dates set (add legs)</em>
            {% endif %}
        </td>
    </tr>
    <tr>
        <th>Actual Completion</th>
        <td>
            {% if trip.actual_completion_datetime %}
                {{ trip.actual_completion_datetime|date:"M d, Y H:i" }}
                <br>
                <small><strong>Duration:</strong> {{ trip.duration_display }}</small>
            {% else %}
                <em>Not completed yet</em>
            {% endif %}
        </td>
    </tr>
    <tr>
        <th>Created By</th>
        <td>{{ trip.created_by.get_full_name|default:trip.created_by.username }}</td>
    </tr>
    <tr>
        <th>Created At</th>
        <td>{{ trip.created_at|date:"M d, Y H:i" }}</td>
    </tr>
    {% if trip.notes %}
        <tr>
            <th>Notes</th>
            <td>{{ trip.notes|linebreaks }}</td>
        </tr>
    {% endif %}
</table>

<!-- Trip Legs -->
<div class="clearfix mt-2">
    <h3 style="float: left;">Trip Legs (Sub-trips)</h3>
    <div style="float: right;">
        {% if perms.trips.change_trip %}
            <a href="{% url 'trip-leg-create' trip.pk %}" class="btn btn-sm">Add Leg</a>
        {% endif %}
    </div>
</div>

{% if trip.legs.all %}
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Client</th>
                <th>Route</th>
                <th>Weight (Tons)</th>
                <th>Price/Ton</th>
                <th>Est. Revenue</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for leg in trip.legs.all %}
                <tr>
                    <td>{{ leg.date|date:"M d, H:i" }}</td>
                    <td>{{ leg.client_name }}</td>
                    <td>{{ leg.pickup_location }} &rarr; {{ leg.delivery_location }}</td>
                    <td>{{ leg.weight|default:"-" }}</td>
                    <td>{{ leg.price_per_ton }}</td>
                    <td>{{ leg.revenue|floatformat:2 }}</td>
                    <td>
                        {% if perms.trips.change_trip %}
                            <a href="{% url 'trip-leg-update' leg.pk %}" class="btn btn-sm btn-warning">Edit</a>
                            <a href="{% url 'trip-leg-delete' leg.pk %}" class="btn btn-sm btn-danger">Delete</a>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            <tr style="background-color: #f9f9f9; font-weight: bold;">
                <td colspan="5" style="text-align: right;">Total Estimated Revenue:</td>
                <td colspan="2">{{ trip.total_revenue|floatformat:2 }}</td>
            </tr>
        </tbody>
    </table>
{% else %}
    <p>No legs added to this trip yet.</p>
{% endif %}

<!-- Trip Expenses -->
<div class="clearfix mt-2">
    <h3 style="float: left;">Trip Expenses</h3>
    <div style="float: right;">
        {% if perms.trips.change_trip %}
            <a href="{% url 'trip-expense-update' trip.pk %}" class="btn btn-sm btn-warning">Update Fixed Expenses</a>
            <a href="{% url 'trip-custom-expense-create' trip.pk %}" class="btn btn-sm">Add Custom Expense</a>
        {% endif %}
    </div>
</div>

<table>
    <thead>
        <tr>
            <th>Expense Type</th>
            <th>Amount</th>
            <th>Notes/Details</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        <!-- Fixed Expenses -->
        <tr>
            <td>Diesel Expense</td>
            <td>{{ trip.diesel_expense|default:0|floatformat:2 }}</td>
            <td>Fixed Entry</td>
            <td>-</td>
        </tr>
        <tr>
            <td>Toll Expense</td>
            <td>{{ trip.toll_expense|default:0|floatformat:2 }}</td>
            <td>Fixed Entry</td>
            <td>-</td>
        </tr>
        
        <!-- Custom Expenses -->
        {% for expense in trip.custom_expenses.all %}
            <tr>
                <td>{{ expense.name }}</td>
                <td>{{ expense.amount|floatformat:2 }}</td>
                <td>{{ expense.notes }}</td>
                <td>
                    {% if perms.trips.change_trip %}
                        <a href="{% url 'trip-custom-expense-delete' expense.pk %}" class="btn btn-sm btn-danger">Delete</a>
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
        
        <tr style="background-color: #f9f9f9; font-weight: bold;">
            <td style="text-align: right;">Total Trip Cost:</td>
            <td>{{ trip.total_cost|floatformat:2 }}</td>
            <td colspan="2"></td>
        </tr>
        
        <!-- Profit/Loss Calculation -->
        <tr style="background-color: #f0f0f0; border-top: 2px solid #ddd;">
             <td style="text-align: right; font-weight: bold;">Estimated Net Profit:</td>
             <td style="font-weight: bold; {% if trip.total_revenue|add:trip.total_cost < 0 %}color: red;{% else %}color: green;{% endif %}">
                {% with profit=trip.total_revenue|add:"-"|add:trip.total_cost %}
                    {{ profit|floatformat:2 }}
                {% endwith %}
             </td>
             <td colspan="2"></td>
        </tr>
    </tbody>
</table>
{% if trip.financial_records.all %}
    <h4 class="mt-2">Legacy Financial Records</h4>
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Category</th>
                <th>Amount</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            {% for record in trip.financial_records.all %}
                <tr>
                    <td>{{ record.date|date:"M d, Y" }}</td>
                    <td>{{ record.category }}</td>
                    <td style="text-align: right; {% if record.is_income %}color: #27ae60;{% else %}color: #e74c3c;{% endif %}">
                        {% if record.is_income %}+{% else %}-{% endif %}${{ record.amount|floatformat:2 }}
                    </td>
                    <td>{{ record.description|truncatechars:50 }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% endif %}
{% endblock %}