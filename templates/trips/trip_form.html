{% extends 'base.html' %}

{% block title %}{% if object %}Edit{% else %}Create{% endif %} Trip - Transport Management System{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <h2 class="mb-4">{% if object %}Edit Trip: {{ object.trip_number }}{% else %}Create New Trip{% endif %}</h2>

        <form method="post">
            {% csrf_token %}
            
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Trip Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Vehicle & Driver -->
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.vehicle.id_for_label }}" class="form-label">Vehicle</label>
                            {{ form.vehicle }}
                            {% if form.vehicle.errors %}<div class="text-danger small">{{ form.vehicle.errors }}</div>{% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.driver.id_for_label }}" class="form-label">Driver</label>
                            {{ form.driver }}
                            {% if form.driver.errors %}<div class="text-danger small">{{ form.driver.errors }}</div>{% endif %}
                        </div>

                        <!-- Party & Locations -->
                        <div class="col-md-12 mb-3">
                            <label for="{{ form.party.id_for_label }}" class="form-label">Party</label>
                            {{ form.party }}
                            {% if form.party.errors %}<div class="text-danger small">{{ form.party.errors }}</div>{% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.pickup_location.id_for_label }}" class="form-label">Pickup Location</label>
                            {{ form.pickup_location }} <!-- Render as select for Select2 tagging -->
                            {% if form.pickup_location.errors %}<div class="text-danger small">{{ form.pickup_location.errors }}</div>{% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.delivery_location.id_for_label }}" class="form-label">Delivery Location</label>
                            {{ form.delivery_location }}
                             {% if form.delivery_location.errors %}<div class="text-danger small">{{ form.delivery_location.errors }}</div>{% endif %}
                        </div>

                        <!-- Cargo Details -->
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.weight.id_for_label }}" class="form-label">Weight (Tons)</label>
                            {{ form.weight }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.rate_per_ton.id_for_label }}" class="form-label">Rate per Ton</label>
                            {{ form.rate_per_ton }}
                        </div>

                        <!-- Odometer -->
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.start_odometer.id_for_label }}" class="form-label">Start Odometer</label>
                            {{ form.start_odometer }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.end_odometer.id_for_label }}" class="form-label">End Odometer</label>
                            {{ form.end_odometer }}
                        </div>

                        <!-- Notes -->
                        <div class="col-12 mb-3">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                            {{ form.notes }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-end gap-2 mb-5">
                <a href="{% if object %}{% url 'trip-detail' object.pk %}{% else %}{% url 'trip-list' %}{% endif %}" 
                   class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-success">
                    {% if object %}Update Trip{% else %}Create Trip{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 1. Initialize Standard Select2
    $('#id_vehicle').select2({
        theme: 'bootstrap-5',
        placeholder: 'Select Vehicle'
    });
    $('#id_driver').select2({
        theme: 'bootstrap-5',
        placeholder: 'Select Driver',
        allowClear: true
    });
    $('#id_party').select2({
        theme: 'bootstrap-5',
        placeholder: 'Select Party'
    });

    // 2. Initialize AJAX Autocomplete for Locations
    function setupLocationAutocomplete(fieldSelector, fieldName) {
        const input = $(fieldSelector);
        if (!input.length) return;
        
        const listId = fieldSelector.replace('#id_', '') + '_list';
        if ($('#' + listId).length === 0) {
            $('<datalist id="' + listId + '"></datalist>').insertAfter(input);
            input.attr('list', listId);
        }

        input.on('input', function() {
            const val = this.value;
            if (val.length < 2) return;
            $.get('{% url "autocomplete-suggestions" %}', { field: fieldName, q: val }, function(data) {
                const datalist = $('#' + listId);
                datalist.empty();
                data.results.forEach(item => {
                    datalist.append(`<option value="${item}">`);
                });
            });
        });
    }

    setupLocationAutocomplete('#id_pickup_location', 'pickup_location');
    setupLocationAutocomplete('#id_delivery_location', 'delivery_location');
});
</script>
{% endblock %}