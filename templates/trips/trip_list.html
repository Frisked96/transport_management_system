{% extends 'base.html' %}

{% block title %}Daily Trip Log - {{ view_date|date:"F d, Y" }}{% endblock %}

{% block content %}
<div class="row mb-3 align-items-center">
    <div class="col-4 text-start">
        <a href="?date={{ previous_date|date:'Y-m-d' }}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-chevron-left"></i> <span class="d-none d-sm-inline">{{ previous_date|date:"M d" }}</span>
        </a>
    </div>
    <div class="col-4 text-center">
        <h4 class="mb-0 d-md-none">{{ view_date|date:"M d, Y" }}</h4>
        <h2 class="mb-0 d-none d-md-block">{{ view_date|date:"l, F d, Y" }}</h2>
        {% if view_date != today %}
            <a href="?date={{ today|date:'Y-m-d' }}" class="btn btn-sm btn-link text-decoration-none">Go to Today</a>
        {% endif %}
    </div>
    <div class="col-4 text-end">
        <a href="?date={{ next_date|date:'Y-m-d' }}" class="btn btn-outline-secondary btn-sm">
            <span class="d-none d-sm-inline">{{ next_date|date:"M d" }}</span> <i class="bi bi-chevron-right"></i>
        </a>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
         <!-- Optional: Date Picker to jump -->
         <form method="get" class="d-inline-block">
            <div class="input-group input-group-sm">
                <input type="date" name="date" class="form-control" value="{{ view_date|date:'Y-m-d' }}">
                <button class="btn btn-outline-secondary" type="submit">Go</button>
            </div>
        </form>
    </div>
    {% if perms.trips.add_trip %}
        <a href="{% url 'trip-create' %}?date={{ view_date|date:'Y-m-d' }}" class="btn btn-success">
            <i class="bi bi-plus-lg"></i> <span class="d-none d-sm-inline">Add Trip for {{ view_date|date:"M d" }}</span><span class="d-sm-none">Add Trip</span>
        </a>
    {% endif %}
</div>

<!-- Search and Filter (Collapsible) -->
<div class="accordion mb-3" id="filterAccordion">
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingFilter">
            <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFilter" aria-expanded="false" aria-controls="collapseFilter">
                <i class="bi bi-funnel me-2"></i> Filters & Search
            </button>
        </h2>
        <div id="collapseFilter" class="accordion-collapse collapse" aria-labelledby="headingFilter" data-bs-parent="#filterAccordion">
            <div class="accordion-body bg-light">
                <form method="get" class="row g-2 align-items-end">
                    <input type="hidden" name="date" value="{{ view_date|date:'Y-m-d' }}">
                    <div class="col-md-6">
                        <label for="search" class="form-label small">Search</label>
                        <input type="text" id="search" name="search" class="form-control form-control-sm" value="{{ search_term }}" placeholder="Trip #, Vehicle, Party...">
                    </div>
                    <div class="col-md-4">
                        <label for="status" class="form-label small">Status</label>
                        <select id="status" name="status" class="form-select form-select-sm">
                            <option value="">All Statuses</option>
                            {% for value, label in status_choices %}
                                <option value="{{ value }}" {% if current_status == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary btn-sm w-100">Apply</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if trips %}
    <!-- Desktop/Tablet View (Table) -->
    <div class="card shadow-sm d-none d-md-block">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Trip #</th>
                        <th>Vehicle</th>
                        <th>Party</th>
                        <th>Route</th>
                        <th class="text-end">Weight</th>
                        <th class="text-end">Rate</th>
                        <th class="text-end">Total</th>
                        <th>Status</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trip in trips %}
                    <tr>
                        <td>
                            <a href="{% url 'trip-detail' trip.pk %}" class="fw-bold text-decoration-none">{{ trip.trip_number }}</a>
                        </td>
                        <td>
                            <span class="badge bg-secondary text-light">{{ trip.vehicle.registration_plate }}</span>
                        </td>
                        <td>{% if trip.party %}{{ trip.party.name }}{% else %}-{% endif %}</td>
                        <td class="small text-muted">
                            {% if trip.pickup_location or trip.delivery_location %}
                                {{ trip.pickup_location|default:"?" }} &rarr; {{ trip.delivery_location|default:"?" }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="text-end">{{ trip.weight|default:"-" }}</td>
                        <td class="text-end">{{ trip.rate_per_ton|default:"-" }}</td>
                        <td class="text-end fw-bold text-success">
                            {% if trip.revenue > 0 %}{{ trip.revenue|floatformat:2 }}{% else %}-{% endif %}
                        </td>
                        <td>
                            <span class="badge bg-{% if trip.status == 'Completed' %}success{% elif trip.status == 'Cancelled' %}danger{% else %}primary{% endif %}">
                                {{ trip.status }}
                            </span>
                        </td>
                        <td class="text-end">
                            <div class="btn-group btn-group-sm">
                                <a href="{% url 'trip-detail' trip.pk %}" class="btn btn-outline-primary" title="View"><i class="bi bi-eye"></i></a>
                                {% if perms.trips.change_trip %}
                                    <a href="{% url 'trip-update' trip.pk %}" class="btn btn-outline-warning" title="Edit"><i class="bi bi-pencil"></i></a>
                                {% endif %}
                                {% if perms.trips.delete_trip %}
                                    <a href="{% url 'trip-delete' trip.pk %}" class="btn btn-outline-danger" title="Delete"><i class="bi bi-trash"></i></a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <td colspan="4" class="fw-bold text-end">Total:</td>
                        <td class="text-end fw-bold">{{ total_weight|floatformat:2 }}</td>
                        <td colspan="4"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Mobile View (Cards) -->
    <div class="d-md-none">
        {% for trip in trips %}
        <div class="card mb-3 shadow-sm border-start border-4 border-{% if trip.status == 'Completed' %}success{% elif trip.status == 'Cancelled' %}danger{% else %}primary{% endif %}">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="card-title mb-0">
                        <a href="{% url 'trip-detail' trip.pk %}" class="text-decoration-none">{{ trip.trip_number }}</a>
                    </h5>
                    <span class="badge bg-secondary">{{ trip.vehicle.registration_plate }}</span>
                </div>
                
                <div class="mb-2">
                    <div class="fw-bold text-dark">{% if trip.party %}{{ trip.party.name }}{% else %}Unknown Party{% endif %}</div>
                    {% if trip.pickup_location or trip.delivery_location %}
                        <div class="small text-muted">
                            <i class="bi bi-geo-alt"></i> {{ trip.pickup_location|default:"?" }} &rarr; {{ trip.delivery_location|default:"?" }}
                        </div>
                    {% endif %}
                </div>

                <div class="d-flex justify-content-between align-items-center bg-light rounded p-2 mb-2">
                    <div class="text-center">
                        <small class="text-muted d-block">Weight</small>
                        <strong>{{ trip.weight|default:"-" }}</strong>
                    </div>
                    <div class="text-center border-start border-end px-3">
                        <small class="text-muted d-block">Rate</small>
                        <strong>{{ trip.rate_per_ton|default:"-" }}</strong>
                    </div>
                    <div class="text-center">
                        <small class="text-muted d-block">Total</small>
                        <strong class="text-success">
                            {% if trip.revenue > 0 %}{{ trip.revenue|floatformat:2 }}{% else %}-{% endif %}
                        </strong>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-{% if trip.status == 'Completed' %}success{% elif trip.status == 'Cancelled' %}danger{% else %}primary{% endif %}">
                        {{ trip.status }}
                    </span>
                    
                    <div class="btn-group btn-group-sm">
                        <a href="{% url 'trip-detail' trip.pk %}" class="btn btn-outline-primary"><i class="bi bi-eye"></i></a>
                        {% if perms.trips.change_trip %}
                            <a href="{% url 'trip-update' trip.pk %}" class="btn btn-outline-warning"><i class="bi bi-pencil"></i></a>
                        {% endif %}
                        {% if perms.trips.delete_trip %}
                            <a href="{% url 'trip-delete' trip.pk %}" class="btn btn-outline-danger"><i class="bi bi-trash"></i></a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        
        <div class="card bg-light border-0">
            <div class="card-body d-flex justify-content-between align-items-center">
                <span class="fw-bold">Total Weight (Day):</span>
                <span class="fw-bold fs-5">{{ total_weight|floatformat:2 }}</span>
            </div>
        </div>
    </div>

{% else %}
    <div class="text-center py-5 text-muted">
        <i class="bi bi-truck display-1"></i>
        <p class="mt-3 lead">No trips recorded for {{ view_date|date:"F d, Y" }}.</p>
        {% if perms.trips.add_trip %}
            <a href="{% url 'trip-create' %}?date={{ view_date|date:'Y-m-d' }}" class="btn btn-primary mt-2">Add First Trip</a>
        {% endif %}
    </div>
{% endif %}

{% endblock %}