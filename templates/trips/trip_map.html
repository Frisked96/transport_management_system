{% extends 'base.html' %}

{% block title %}Trip Map - Transport Management System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Trip Route Map</h2>
    <a href="{% url 'trip-list' %}" class="btn btn-outline-secondary">Back to List</a>
</div>

<!-- Filter Form -->
<div class="card shadow-sm mb-3">
    <div class="card-body py-2">
        <form method="get" class="row g-2 align-items-end">
            <div class="col-md-3">
                <label class="form-label small mb-1">Start Date</label>
                <input type="date" name="start_date" class="form-control form-control-sm" value="{{ start_date|date:'Y-m-d' }}">
            </div>
            <div class="col-md-3">
                <label class="form-label small mb-1">End Date</label>
                <input type="date" name="end_date" class="form-control form-control-sm" value="{{ end_date|date:'Y-m-d' }}">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary btn-sm w-100">Filter</button>
            </div>
        </form>
    </div>
</div>

<!-- Map Container -->
<div class="card shadow-sm">
    <div class="card-body p-0">
        <div id="map" style="height: 600px; width: 100%;"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Map (Centered on India)
        var map = L.map('map').setView([20.5937, 78.9629], 5);

        // Add OpenStreetMap Tile Layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Trip Data from Django View
        var trips = {{ trips_json|safe }};
        
        if (trips.length === 0) {
            // If no trips, show a message?
            return;
        }

        var bounds = L.latLngBounds();

        trips.forEach(function(trip) {
            // Draw Pickup Marker (Green)
            var pickupMarker = L.circleMarker(trip.start, {
                color: 'green',
                fillColor: '#2ecc71',
                fillOpacity: 1,
                radius: 6
            }).addTo(map).bindPopup(`
                <b>Pickup:</b> ${trip.pickup_name}<br>
                <b>Trip:</b> <a href="${trip.url}">${trip.trip_number}</a><br>
                <b>Date:</b> ${trip.date}
            `);

            // Draw Delivery Marker (Red)
            var deliveryMarker = L.circleMarker(trip.end, {
                color: 'red',
                fillColor: '#e74c3c',
                fillOpacity: 1,
                radius: 6
            }).addTo(map).bindPopup(`
                <b>Delivery:</b> ${trip.delivery_name}<br>
                <b>Trip:</b> <a href="${trip.url}">${trip.trip_number}</a><br>
                <b>Vehicle:</b> ${trip.vehicle}
            `);

            // Draw Route Line (Blue)
            var routeLine = L.polyline([trip.start, trip.end], {
                color: 'blue',
                weight: 3,
                opacity: 0.7,
                dashArray: '10, 10' // Dashed line to indicate straight-line distance (flight path)
            }).addTo(map);

            // Add info to line
            routeLine.bindPopup(`
                <b>${trip.trip_number}</b><br>
                ${trip.pickup_name} âžœ ${trip.delivery_name}<br>
                ${trip.vehicle}
            `);

            bounds.extend(trip.start);
            bounds.extend(trip.end);
        });

        // Fit map to show all routes
        if (trips.length > 0) {
            map.fitBounds(bounds, {padding: [50, 50]});
        }
    });
</script>
{% endblock %}
